import logging
import requests
from aiogram import Bot, Dispatcher, executor, types
from aiogram.contrib.fsm_storage.memory import MemoryStorage
from aiogram.dispatcher.filters.state import State, StatesGroup
from aiogram.dispatcher.filters import Text
from aiogram.dispatcher import FSMContext


STANDART_TOKEN = "308a347c3b38e85bfbc5ae53f6758ade"


# –û–±—ä–µ–∫—Ç –±–æ—Ç–∞
bot = Bot(token="1913319721:AAFPa-vvm1RMBBcg3Ya5jpsrFNUb0m5N8nA")
# –î–∏—Å–ø–µ—Ç—á–µ—Ä –¥–ª—è –±–æ—Ç–∞
dp = Dispatcher(bot, storage=MemoryStorage())
# –í–∫–ª—é—á–∞–µ–º –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ, —á—Ç–æ–±—ã –Ω–µ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å –≤–∞–∂–Ω—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è
logging.basicConfig(level=logging.INFO)


def get_reply_keyboard(buttons: list):
    keyboard = types.ReplyKeyboardMarkup(resize_keyboard=True)
    keyboard.add(*buttons)
    return keyboard


class Form(StatesGroup):
    services = State()
    type_key = State()
    api_key = State()
    site = State()
    email = State()
    send_message = State()


async def set_default_commands(dp):
    await dp.bot.set_my_commands([
        types.BotCommand("start", "–£—Å–ª—É–≥–∏")
    ])


# –•—ç–Ω–¥–ª–µ—Ä –Ω–∞ –∫–æ–º–∞–Ω–¥—É /start
@dp.message_handler(commands="start")
async def cmd_test1(message: types.Message):
    keyboard = get_reply_keyboard(["–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ —Å –ø–æ—á—Ç—ã kopeechka.storeüìß"])
    await Form.services.set()
    await message.answer("–í—ã–±–µ—Ä–∏—Ç–µ —É—Å–ª—É–≥—É", reply_markup=keyboard)


# –î–æ–±–∞–≤–ª—è–µ–º –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø–µ—Ä–µ–¥—É–º–∞–ª –∑–∞–ø–æ–ª–Ω—è—Ç—å
@dp.message_handler(state='*', commands='cancel')
@dp.message_handler(Text(equals='–æ—Ç–º–µ–Ω–∞', ignore_case=True), state='*')
async def cancel_handler(message: types.Message, state: FSMContext):
    current_state = await state.get_state()
    if current_state is None:
        return

    await state.finish()
    await message.reply('–•–æ—Ä–æ—à–æ')


"""# –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–Ω–æ–ø–∫–∏ '–Ω–∞–∑–∞–¥'
@dp.message_handler(lambda message: message.text == "–Ω–∞–∑–∞–¥", state='*')
async def get_previous_state(message: types.Message):
    await Form.previous()"""


# –û–±—Ä–∞–±–æ—Ç–∫–∞ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –≤–≤–µ–¥–µ–Ω–æ–π —É—Å–ª—É–≥–∏
@dp.message_handler(lambda message: message.text != "–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ —Å –ø–æ—á—Ç—ã kopeechka.storeüìß",
                    state=Form.services)
async def which_api_key_use_invalid(message: types.Message):
    await message.reply("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —É—Å–ª—É–≥—É.")


# –ü—Ä–∏–Ω–∏–º–∞–µ–º —É—Å–ª—É–≥—É
@dp.message_handler(state=Form.services)
async def which_api_key_use(message: types.Message):
    keyboard = get_reply_keyboard(["–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API KEY", "–í–≤–µ—Å—Ç–∏ —Å–≤–æ–π API KEY"])
    await Form.type_key.set()
    await message.reply("–ö–∞–∫–æ–π API –∫–ª—é—á –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å?", reply_markup=keyboard)


# –ü—Ä–æ–≤–µ—Ä—è–µ–º —Ç–∏–ø API KEY
@dp.message_handler(lambda message: message.text not in ["–°—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π API KEY", "–í–≤–µ—Å—Ç–∏ —Å–≤–æ–π API KEY"],
                    state=Form.type_key)
async def process_type_key_invalid(message: types.Message):
    return await message.reply("–í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π —Ç–∏–ø API KEY –∏–ª–∏ –Ω–∞–ø–∏—à–∏ /cancel")


# –°—é–¥–∞ –ø—Ä–∏—Ö–æ–¥–∏—Ç –æ—Ç–≤–µ—Ç —Å —Ç–∏–ø–æ–º API KEY
@dp.message_handler(state=Form.type_key)
async def process_name(message: types.Message, state: FSMContext):
    async with state.proxy() as data:
        data['type_api'] = message.text

        if message.text == "–í–≤–µ—Å—Ç–∏ —Å–≤–æ–π API KEY":
            await Form.api_key.set()
            await message.reply("–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π API.")
        else:
            data['api_key'] = STANDART_TOKEN
            keyboard = get_reply_keyboard(["facebook.com", "vk.com"])
            await Form.site.set()
            await message.reply("–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π —Å–∞–π—Ç –∏–ª–∏ –≤—ã–±–∏—Ä—Ç–∏–µ –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö.", reply_markup=keyboard)


@dp.message_handler(state=Form.site)
async def process_site(message: types.Message, state: FSMContext):
    async with state.proxy() as data:
        data['site'] = message.text
        await Form.email.set()
        await message.reply("–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π email")


# –ü—Ä–∏–Ω–∏–º–∞–µ–º API KEY –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
@dp.message_handler(state=Form.api_key)
async def get_user_api_key(message: types.Message, state: FSMContext):
    await Form.next()
    await state.update_data(api_key=message.text)
    keyboard = get_reply_keyboard(["facebook.com", "vk.com"])
    await message.reply("–í–≤–µ–¥–∏—Ç–µ —Å–≤–æ–π —Å–∞–π—Ç –∏–ª–∏ –≤—ã–±–∏—Ä—Ç–∏–µ –∏–∑ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–Ω—ã—Ö.", reply_markup=keyboard)


# –°–æ—Ö—Ä–∞–Ω—è–µ–º email
@dp.message_handler(state=Form.email)
async def process_get_email(message: types.Message, state: FSMContext):
    async with state.proxy() as data:
        data['email'] = message.text
        keyboard = get_reply_keyboard(["–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"])
        await Form.next()
        await message.answer(f"–ù–∞ —Å–∞–π—Ç–µ {data['site']} –Ω–∞–∂–º–∏—Ç–µ "
                             f"–ø–æ–ª—É—á–∏—Ç—å –∫–æ–¥ –ø–æ –ø–æ—á—Ç–µ, –ø–æ—Å–ª–µ —ç—Ç–æ–≥–æ –Ω–∞–∂–º–∏—Ç–µ '–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω'",
                             reply_markup=keyboard)


# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∑–∞–ø—Ä–æ—Å –Ω–∞ —Å–∞–π—Ç –∫–æ–ø–µ–µ—á–∫–∏
@dp.message_handler(lambda message: message.text == "–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω",
                    state=Form.send_message)
async def process_get_code(message: types.Message, state: FSMContext):
    keyboard = get_reply_keyboard(["–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ —Å –ø–æ—á—Ç—ã kopeechka.storeüìß"])
    await message.answer("–°–µ–π—á–∞—Å –ø–æ–ª—É—á–∏–º –∫–æ–¥")
    async with state.proxy() as data:
        response = requests.get(
            'http://api.kopeechka.store/mailbox-get-fresh-id',
            params={'token': data['api_key'],
                    'site': data['site'],
                    'email': data['email'],
                    'type': 'json',
                    'api': '2.0'},
        )
        response = response.json()
        print(response)
        if response['status'] == 'OK':
            task_id = response['id']
            response = requests.get(
                'http://api.kopeechka.store/mailbox-get-message',
                params={'full': '0',
                        'id': task_id,
                        'token': data['api_key'],
                        'type': 'json',
                        'api': '2.0'},
            )
            response = response.json()
            print(response)
            if response['status'] == "OK":
                await message.answer(response['fullmessage'], reply_markup=keyboard)
                await state.finish()
            elif response['status'] == "ERROR":
                await message.answer("–í—ã –Ω–µ –æ—Ç–ø—Ä–∞–≤–∏–ª–∏ –ø–∏—Å—å–º–æ.",
                                     reply_markup=get_reply_keyboard(["–ö–æ–¥ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω"]))
        else:
            await message.answer("API –∏–ª–∏ email –∏–ª–∏ —Å–∞–π—Ç –Ω–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã, –ø–æ—Ä–æ–±—É–π—Ç–µ –∑–∞–Ω–æ–≤–æ –≤–≤–µ—Å—Ç–∏ –∏—Ö",
                                 reply_markup=get_reply_keyboard(["–ü–æ–ª—É—á–∏—Ç—å –∫–æ–¥ —Å –ø–æ—á—Ç—ã kopeechka.storeüìß"]))
            await Form.services.set()


if __name__ == "__main__":
    # –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
    executor.start_polling(dp, skip_updates=True, on_startup=set_default_commands)
